<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Jengine</title>
	<style>
html, body {
	margin: 0;
	height: 100%;
	font-family: sans-serif;
	font-size: 18px;
	background-color: #fff;
	color: #000;
	display: flex;
	justify-content: center;
	align-items: center;
}

#wrapper {
	width: 100%;
	text-align: center;
}

#main {
	padding: 10px;
	border: 1px solid #000;
	border-radius: 8px;
	box-sizing: border-box;
	background-color: #f9f9f9;
	display: inline-block;
}

canvas {
	display: block;
	margin: 0 auto;
	background: #000;
	max-width: 100%;
}

@media (max-width: 850px) {
	body {
		font-size: 80%;
	}
}
	</style>
</head>
<body>
<div id="wrapper">
	<div id="main">
		<canvas id="canvas" width="576" height="600"></canvas>
	</div>
</div>

<script>
(function(){
	var TXT = {
		PLAYBTN: 'Begin Simulator',
		LOAD:    'Downloading Physics Bodies',
		PARSE:   'Preparing Physics Bodies',
		EXECUTE: 'Starting Simulation',
		DLERROR: 'Error while downloading physics data.\nCheck your internet connection.',
		NOWEBGL: 'Your browser or graphics card does not seem to support WebGL.'
	};

	var canvas = document.getElementById('canvas'), ctx;

	var Msg = function(m) {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.fillStyle = '#555';
		for (var i = 0, a = m.split('\n'), n = a.length; i != n; i++)
			ctx.fillText(a[i], canvas.width/2, canvas.height/2-(n-1)*20+10+i*40);
	};

	var Fail = function(m) {
		canvas.outerHTML =
			'<div style="width:'+canvas.clientWidth+'px;height:'+canvas.clientHeight+'px;background:#000;display:flex;align-items:center;justify-content:center;color:#000;text-align:center;padding:1em;">'
			+ TXT.NOWEBGL + (m?'<br><br>'+m:'') + '</div>';
	};

	var DoExecute = function() {
		Msg(TXT.EXECUTE);
		Module.canvas = canvas.cloneNode(false);
		Module.canvas.oncontextmenu = function(e){ e.preventDefault(); };
		Module.setWindowTitle = function() {};
		Module.postRun = function() {
			if (!Module.noExitRuntime) { Fail(); return; }
			canvas.parentNode.replaceChild(Module.canvas, canvas);
			TXT = Msg = ctx = canvas = null;
			Module.canvas.focus();
		};
		setTimeout(function(){ Module.run(['/p']); }, 50);
	};

	var DoLoad = function() {
		Msg(TXT.LOAD);
		var xhr = new XMLHttpRequest();
		xhr.open('GET', 'index.js');
		xhr.onerror = xhr.onabort = function() {
			Msg(TXT.DLERROR); canvas.disabled = false;
		};
		xhr.onload = function() {
			if (xhr.status != 200) {
				Msg(TXT.DLERROR + '\nStatus: ' + xhr.statusText);
				canvas.disabled = false;
				return;
			}
			Msg(TXT.PARSE);
			setTimeout(function() {
				window.onerror = function(e,u,l){ Fail(e+' ('+u+':'+l+')'); };
				Module = { TOTAL_MEMORY: 1024*1024*240, TOTAL_STACK: 1024*1024*20, currentScriptUrl: '-', preInit: DoExecute };
				var s = document.createElement('script');
				s.textContent = xhr.response;
				document.documentElement.appendChild(s);
				document.documentElement.removeChild(s);
				xhr = xhr.response = s = s.textContent = null;
			}, 50);
		};
		xhr.send();
	};

	var DoSetup = function() {
		canvas.onclick = function() {
			if (canvas.disabled) return;
			canvas.disabled = true;
			canvas.scrollIntoView();
			ctx.pCnt = 0;
			DoLoad();
		};
		ctx.fillStyle = '#ccc';
		ctx.fillRect(canvas.width/2-254, canvas.height/2-104, 508, 208);
		ctx.fillStyle = '#eee';
		ctx.fillRect(canvas.width/2-250, canvas.height/2-100, 500, 200);
		ctx.fillStyle = '#000';
		ctx.fillText(TXT.PLAYBTN, canvas.width/2, canvas.height/2+10);
	};

	canvas.oncontextmenu = function(e){ e.preventDefault(); };
	ctx = canvas.getContext('2d');
	ctx.font = '24px sans-serif';
	ctx.textAlign = 'center';
	DoSetup();
})();
</script>
</body>
</html>
